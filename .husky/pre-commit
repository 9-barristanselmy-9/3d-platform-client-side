echo "ğŸš€ Running pre-commit checks..."

# Get current branch name
BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo "ğŸ“ Current branch: $BRANCH"

# Remove Prisma temporary files from staging
echo "ğŸ§¹ Removing Prisma temporary files from staging..."
git reset HEAD -- lib/generated/prisma/*.tmp* 2>/dev/null || true

# Run ESLint on staged files
echo "ğŸ“ Running ESLint on staged files..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx)$' || true)
if [ -n "$STAGED_FILES" ]; then
  echo "Checking files: $STAGED_FILES"
  npx eslint $STAGED_FILES --fix
  if [ $? -ne 0 ]; then
    echo "âŒ ESLint failed. Please fix the linting errors above."
    exit 1
  fi
  # Add back the fixed files
  git add $STAGED_FILES
else
  echo "âœ… No JavaScript/TypeScript files to lint."
fi

# Run TypeScript type checking on the entire project
echo "ğŸ”§ Running TypeScript type checking..."
npx tsc --noEmit
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript type checking failed. Please fix the type errors above."
  exit 1
fi

# Run build only when committing to main branch
if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
  echo "ğŸ—ï¸ Running build check (main branch detected)..."
  npm run build
  if [ $? -ne 0 ]; then
    echo "âŒ Build failed. Please fix the build errors above."
    exit 1
  fi
  echo "âœ… Build check passed!"
else
  echo "â­ï¸ Skipping build check (not on main branch)"
fi

echo "âœ… All pre-commit checks passed!"
