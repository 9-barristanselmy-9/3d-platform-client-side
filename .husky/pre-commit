echo "🚀 Running pre-commit checks..."

# Get current branch name
BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo "📍 Current branch: $BRANCH"

# Remove Prisma temporary files from staging
echo "🧹 Removing Prisma temporary files from staging..."
git reset HEAD -- lib/generated/prisma/*.tmp* 2>/dev/null || true

# Run ESLint on staged files
echo "📝 Running ESLint on staged files..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx)$' || true)
if [ -n "$STAGED_FILES" ]; then
  echo "Checking files: $STAGED_FILES"
  npx eslint $STAGED_FILES --fix
  if [ $? -ne 0 ]; then
    echo "❌ ESLint failed. Please fix the linting errors above."
    exit 1
  fi
  # Add back the fixed files
  git add $STAGED_FILES
else
  echo "✅ No JavaScript/TypeScript files to lint."
fi

# Run TypeScript type checking on the entire project
echo "🔧 Running TypeScript type checking..."
npx tsc --noEmit
if [ $? -ne 0 ]; then
  echo "❌ TypeScript type checking failed. Please fix the type errors above."
  exit 1
fi

# Run build only when committing to main branch
if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
  echo "🏗️ Running build check (main branch detected)..."
  npm run build
  if [ $? -ne 0 ]; then
    echo "❌ Build failed. Please fix the build errors above."
    exit 1
  fi
  echo "✅ Build check passed!"
else
  echo "⏭️ Skipping build check (not on main branch)"
fi

echo "✅ All pre-commit checks passed!"
